
<link rel="import" href="../../../bower_components/vaadin-charts/vaadin-line-chart.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">



<dom-module id="omp-analytics">
    <template>
        <vaadin-line-chart>
            <chart-title>Orders</chart-title>
            <x-axis name="Price" type="datetime">
                <chart-title>Date</chart-title>
            </x-axis>
            <y-axis>
                <chart-title>Price</chart-title>
            </y-axis>

            <!--<y-axis id="humidity">-->
                <!--<chart-title>Humidity (%)</chart-title>-->
                <!--<min>0</min>-->
                <!--<opposite>true</opposite>-->
            <!--</y-axis>-->


            <!--<data-series name="Humidity" type="column" data="[[humidityData]]"  y-axis = "humidity">-->
            <!--</data-series>-->

            <data-series name="Temperature" data="[[temperatureData]]">
            </data-series>

        </vaadin-line-chart>

    </template>


<script>
    class OmpAnalytics extends Polymer.Element {

        constructor() {
            super();
        }
        static get is() {
            return 'omp-analytics';
        }

        static get properties() {
            return {
                title: {
                    type: String,
                    value: "omp-analytics"
                },
                openPositions: {
                    type: Array,
                    value: []
                },
                openPrice: {
                    type: Array,
                    value: []
                },
            }
        }

        connectedCallback() {
            super.connectedCallback();
            //console.log(this);
            axios.get(`/book/openpositions`)
                .then(function(d) {
                    //console.log("####### ", d.data);
                    this.openPositions = d.data;
                }.bind(this)).then(function(){
                    //console.log("Open Positions", this.openPositions);
                    var tempP = [];
                    for (let k =0; k< this.openPositions.length; k++){
                        //console.log("Value of openPositions[k]: ", this.openPositions[k]);
                        if(this.openPositions[k].total >0){
                            tempP.push(axios.get("/book/openpricepos/"+this.openPositions[k]._id))
                        } else {
                            tempP.push(axios.get("/book/openpriceneg/" + this.openPositions[k]._id))
                                }
                        }
                        return Promise.all(tempP)
                    }.bind(this)).then(function(d){
                    d.forEach(function(s){
                        this.openPrice.push(s.data)
                    }.bind(this))


                for (let k =0; k< this.openPositions.length; k++) {
                    this.openPositions[k].openprice = this._calOpenPrice(this.openPrice[k], this.openPositions[k].total);
//                    console.log("this.openPrice is array?", Array.isArray(this.openPrice));
//                    console.log("this.openPrice content: ", this.openPrice);
//                    console.log("length of this.openPrice", this.openPrice.length);
//                    console.log("value of this.openPositions[k]: ", this.openPositions[k]);
                }

                }.bind(this))


//                        //todo, problem in the callback
//                        //this.openPositions[k].openprice = this._calOpenPrice(this.openPrice[k], this.openPositions[k].total);
//                        console.log("Value of k: ", k);
//                        console.log("this.openPrice is array?", Array.isArray(this.openPrice));
//                        console.log("this.openPrice content: ", this.openPrice);
//                        console.log("length of this.openPrice", this.openPrice.length);
//                        console.log("value of openPrice[k] to be passed  to _calOpenPrice as p", this.openPrice[k]);
//                        console.log("Value of this.openPosition[k].total to be passed to _calOpenPrice as oq: ", this.openPositions[k].total);
//                        //console.log("Value of this.open.position[k]: ",this.openPositions[k]);
//                    }
//
//                }.bind(this));

//            console.log("Value of openPostions: ", this.openPositions);
//            console.log("Value of openPrice: ", this.openPrice );

        }

        _sgn(x){
            if (x == 0){
                return 0;
            } else if(x>0){
                return 1;
            } else {
                return -1;
            }
        }


        _calOpenPrice(p, oq){
//            console.log("Inside method: _calOpenPrice");
//            console.log("Value of p.length: ", p.length);
//            console.log("Value of p: ", p[0]);
//            console.log("Value of oq: ", oq);
            var rq = 0;
            var op = 0;
            var i = p.length;
            while ((Math.abs(rq)<= Math.abs(oq)) && (this._sgn(rq) == this._sgn(oq))){
                console.log("$$$$ value of op: ", op);
                for(i = p.length -1; i>=0; i--) {
                    rq = rq + p[i].quantity;
                    op = op + p[i].quantity * p[i].price;
                }
            }
            console.log("Value of op after the while: ", op);
            i++;
            op = op - p.price * (rq-oq);
            op = op/oq;
            return op;
        }

    }

    customElements.define(OmpAnalytics.is, OmpAnalytics);





</script>


</dom-module>