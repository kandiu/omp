
<link rel="import" href="../../../bower_components/vaadin-charts/vaadin-scatter-chart.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="omp-analytics">
    <template>
        <vaadin-scatter-chart on-selection="selectionListener">
            <chart-title>Orders</chart-title>
            <tooltip enabled="false"></tooltip>

            <!--<plot-options>-->
                <!--<series point-start="1">-->
                <!--</series>-->
            <!--</plot-options>-->

            <x-axis id="time" name="time" type="datetime">
                <chart-title>Date</chart-title>
            </x-axis>
            <y-axis id="q">
                <chart-title>Quantity</chart-title>
            </y-axis>
            <!--<y-axis id="humidity">-->
            <!--<chart-title>Humidity (%)</chart-title>-->
            <!--<min>0</min>-->
            <!--<opposite>true</opposite>-->
            <!--</y-axis>-->
            <!--<data-series name="Humidity" type="column" data="[[humidityData]]"  y-axis = "humidity">-->
            <!--</data-series>-->

            <data-series name="quantity" data="[[datas]]" y-axis="q">
            </data-series>
        </vaadin-scatter-chart>
    </template>
    <!--<script src="data:text/javascript;charset=utf-8,Polymer(%7Bis%3A'xy-chart-selection-example'%2CselectionListener%3Afunction(a)%7Bvar%20b%3Da.detail.originalEvent%2Cc%3Db.xAxis%5B0%5D.min%2Cd%3Db.xAxis%5B0%5D.max%2Cf%3Db.yAxis%5B0%5D.min%2Cg%3Db.yAxis%5B0%5D.max%2Ch%3D%7Btype%3A'arearange'%2CfillOpacity%3A0.1%2ClineWidth%3A0%7D%3Bh.data%3D%5B%5Bc%2Cf%2Cg%5D%2C%5Bd%2Cf%2Cg%5D%5D%2Ca.target.chart.addSeries(h%2C!0%2C!0)%2Cb.preventDefault()%7D%7D)%3B%0A%2F%2F%23%20sourceURL%3Dhttps%3A%2F%2Fdemo.vaadin.com%2Fvaadin-charts%2Fsrc%2Fdemos%2Fdynamic%2Fxy-chart-selection.html.js%0A"></script>-->
</dom-module>

<script>
    class OmpAnalytics extends Polymer.Element {

        constructor() {
            super();
        }
        static get is() {
            return 'omp-analytics';
        }

        static get properties() {
            return {
                title: {
                    type: String,
                    value: "omp-analytics"
                },
                openPositions: {
                    type: Array,
                    value: []
                },
                openPrice: {
                    type: Array,
                    value: []
                },
                book: {
                    type: Array,
                    value: []
                },
                dataQuantity: {
                    type: Array,
                    value: []
                }
            }
        }
        connectedCallback() {
            super.connectedCallback();
            axios.get(`/book/openpositions`)
                .then(function(d) {
                    this.openPositions = d.data;
                }.bind(this)).then(function(){
                    var tempP = [];
                    for (let k =0; k< this.openPositions.length; k++){
                        if(this.openPositions[k].total >0){
                            tempP.push(axios.get("/book/openpricepos/"+this.openPositions[k]._id))
                        } else {
                            tempP.push(axios.get("/book/openpriceneg/" + this.openPositions[k]._id))
                                }
                        }
                        return Promise.all(tempP)
                    }.bind(this)).then(function(d){
                    d.forEach(function(s){
                        this.openPrice.push(s.data)
                    }.bind(this));

                for (let k =0; k< this.openPositions.length; k++) {
                    this.openPositions[k].openprice = this._calOpenPrice(this.openPrice[k], this.openPositions[k].total);
                }
                console.log("Values of openPositions: ", this.openPositions);
                }.bind(this));

            axios.get(`/book`)
                .then(function(d) {
                    this.book = d.data;
                    let res = this.book.map(function(d) {
                        let t =  Date.parse(d.timestamp);
                        let v =  d.quantity;

                        return [t, v]

                    }.bind(this));

                    this.set('datas', res)
                    console.log("Data for chart: ", res)
                }.bind(this))
        }

        _sgn(x){
            if (x == 0){
                return 0;
            } else if(x>0){
                return 1;
            } else {
                return -1;
            }
        }


        _calOpenPrice(p, oq) {
            var op = 0;
            var i = p.length;
            var rq = 0;
            for (i = p.length - 1; i >= 0; i--) {
                if (this._sgn([p[i].quantity]) == this._sgn(oq)) {
                    rq = rq + p[i].quantity;
                    op = op + p[i].quantity * p[i].price;
                }
                if((Math.abs(rq)>= Math.abs(oq))){
                    break;
                }
            }
            op = op / oq;
            return op;
        }
    }

    customElements.define(OmpAnalytics.is, OmpAnalytics);

</script>


</dom-module>
