<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/vaadin-valo-theme/vaadin-combo-box.html">
<link rel="import" href="../../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../../bower_components/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../../bower_components/vaadin-valo-theme/vaadin-button.html">
<link rel="import" href="../../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../../../bower_components/vaadin-radio-button/vaadin-radio-button.html">
<link rel="import" href="../../../bower_components/vaadin-valo-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="omp-builder">
    <template>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
        <style>
         .section-title{
             text-transform: uppercase;
             font-weight: bold;
         }
         #quantity {
             border-radius: 0px;
             text-aling:center;
         }
        </style>
        <div id="topbar" class="row">
            <div class="col-3">
                <vaadin-combo-box id="user" label="User" items="{{_users}}" value="{{_selectedUser}}"></vaadin-combo-box>
            </div>
            <div class="col-3">
                <vaadin-combo-box id="portfolio" label="Portfolio" items="[[_portfolios]]" value="{{_selectedPortfolio}}"></vaadin-combo-box>
            </div>
            <div class="col-3">
                <vaadin-combo-box id="asset-class" label="Asset class" items="[[_assetClasses]]" value="{{_selectedAssetClass}}"></vaadin-combo-box>
            </div>
            <div class="col-3">
                <vaadin-combo-box id="broker" label="Broker" items="[[_brokers]]" value="{{_selectedBroker}}"></vaadin-combo-box>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-4">
                <!-- ASSET DETAIL -->
                <div class="row">
                    <div class="col">
                        <div class="section-title">ASSET DETAILS</div>
                    </div>
                </div>
                <template is="dom-if" if="{{ _isEquity(_selectedAssetClass)}}">
                    <div class="row">
                        <div class="col">
                            <vaadin-combo-box id="symbol" label="Symbol" items="{{_symbols}}" value="{{_selectedSymbol}}" on-value-changed="_symbolChanged"></vaadin-combo-box>
                        </div>
                    </div>
                </template>
                <template is="dom-if" if="{{ _isFutureOrOption(_selectedAssetClass)}}">
                    <div class="row">
                        <div class="col">
                            <vaadin-combo-box id="underlying" label="Underlying" items="{{_symbols}}" value="{{_selectedSymbol}}" on-value-change="_symbolChanged"></vaadin-combo-box>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <vaadin-date-picker label="Maturity">
                            </vaadin-date-picker>
                        </div>
                    </div>
                    <template is="dom-if" if="{{ _isOption(_selectedAssetClass)}}">
                        <vaadin-text-field  id="strike" value="" label="Strike"></vaadin-text-field>
                    </template>
                </template>
                <div class="row">
                    <div class="col">
                        <vaadin-text-field id="exchange" label="Exchange" value="{{_exchange}}"></vaadin-text-field>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <vaadin-text-field readonly value="{{_currency}}" label="Currency"></vaadin-text-field>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <!-- ORDER SETTIGS -->
                <div class="row">
                    <div class="col">
                        <div class="section-title">ORDER SETTINGS</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <vaadin-combo-box id="type" label="Type" value="{{_selectedType}}"></vaadin-combo-box>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <vaadin-combo-box id="duration" label="Duration" value="{{_selectedDuration}}"></vaadin-combo-box>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <template is="dom-if" if="{{ _isMKT(_selectedType)}}">
                            <vaadin-text-field readonly value="50" label="Price"></vaadin-text-field>
                        </template>
                        <template is="dom-if" if="{{ !_isMKT(_selectedType) }}">
                            <vaadin-text-field value="{{_price}}" label="Price"></vaadin-text-field>
                        </template>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <!-- QUANTITY -->
                <div class="row">
                    <div class="col">
                        <div class="section-title mb-4">QUANTITY</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="10">10</button>
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="20">20</button>
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="50">50</button>
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="100">100</button>
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="200">200</button>
                            <button type="button" class="btn btn-light" on-click="_changeQuantity" data="300">300</button>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col">
                        <div class="btn-group" role="group" aria-label="Basic example">
                            <button type="button" class="btn btn-secondary" on-click="_changeQuantity" data="1">+</button>
                            <input id="quantity" type="text" class="form-control" value="{{_quantity}}">
                            <button type="button" class="btn btn-secondary" on-click="_changeQuantity" data="-1">-</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-2">
            <div class="col">
                <div class="btn-group float-right" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-success" on-click="sendOrder" data="buy">BUY</button>
                    <button type="button" class="btn btn-danger" on-click="sendOrder" data="sell">SELL</button>
                </div>
            </div>
        </div>
    </template>
    <script>
     class OmpBuilder extends Polymer.Element{
         static get is() { return 'omp-builder'; }
         static get properties(){
             return {
                 _users: {
                     type: Array,
                     value: () => ['igor', 'uma', 'marcel', 'eljon', 'robert']
                 },
                 _userData: {
                     type: Object,
                     value: () => {}
                 },
                 _quantity: {
                     type: Number,
                     value: 50
                 },
                 _selectedType: {
                     type: String,
                     value: "MKT"
                 },
                 _symbols:{
                     type: Array,
                     value: () => []
                 },

		 _selectedSymbol: {
		     type: Array,
		     observer: '_symbolChanged'
		 },
                 _selectedUser: {
                     type: String,
		     value: 'igor',
		     observer: '_userChanged'
                 },

		 _currency: {
		     type: String,
		     value: "CHF"
		 },

		 _portfolios: {
		     type: Array,
		     value: () => [],
		 },
		 _selectedPortfolio: {
		     type: String,
		     observer: '_portfolioChanged'
		 },

		 _assetClasses: {
		     type: Array,
		     value: () => []
		 },

		 _selectedAssetClass: {
		     type: String,
		     observer: '_assetClassChanged'
		 },

		 _brokers: {
		     type: Array,
		     value: () => []
		 },

		 _selectedBroker: {
		     type: String,
		     /* observer: '_brokerChanged'*/
		 },

		 _exchange: {
		     type: String,
		 },

		 _selectedDuration: {
		     type: String,
		     value: "DAY"
		 },

		 _price:{
		     type: Number,
		     value: 50
		 }
             }
         }
         connectedCallback() {
             super.connectedCallback();
             this.$["duration"].items = ["DAY", "GTC"]
             this.$["type"].items = ["MKT", "LMT"]
         }

         _userChanged(ev) {
	     axios.get(`/login/${this._selectedUser}`)
                  .then( function(res){
                      this.set('_userData', res.data);
		      this.set('_portfolios', udPortfolioIds(this._userData));
		      this.set('_selectedPortfolio', this._portfolios[0]);
                  }.bind(this))

         }
         _portfolioChanged(ev){
	     if ( this._userData ) {
		 this.set('_assetClasses', udAssetClasses(this._userData, this._selectedPortfolio));
		 this.set('_selectedAssetClass', this._assetClasses[0]);
		 this.set('_brokers', udBrokers(this._userData, this._selectedPortfolio));
		 this.set('_selectedBroker', this._brokers[0]);
	     }

         }
         _assetClassChanged(ev){
	     if ( this._userData ) {
		 this.set('_symbols', udSymbols(this._userData, this._selectedPortfolio, this._selectedAssetClass));
		 this.set('_selectedSymbol', this._symbols[0]);
	     }
         }

	 _symbolChanged(ev) {
	     if ( this._userData ){
		 axios.get(`/registry/${this._selectedSymbol}`)
		      .then(function(reg){
			  console.log(reg)
			  this.set('_currency', getCurrency(reg.data));
			  this.set('_exchange', getExchange(reg.data));
		      }.bind(this));
	     }
	 }

         _changeQuantity(el){
             this.set("_quantity", this.get("_quantity") + parseInt(el.target.getAttribute("data")));
         }
         _isEquity(s){
             return s === "Equity";
         }
         _isFuture(s){
             return s === "Future";
         }
         _isOption(s){
             return s === "Option";
         }
         _isFutureOrOption(s) {
             return this._isFuture(s) || this._isOption(s)
         }
         _isMKT(s){
             return s === "MKT"
         }

	 sendOrder(ev){
	     console.log("Buy clicked")
	     let order = {
		 side : ev.target.getAttribute('data'),
		 symbol: this._selectedSymbol,
		 quantity: this._quantity,
		 type: this._selectedType,
		 price: this._selectedType === 'MKT' ? 50 : this._price,
		 duration: this._selectedDuration
	     }

	     this.dispatchEvent(new CustomEvent('new-order', {detail: order }))
	 }
     }
     customElements.define(OmpBuilder.is, OmpBuilder);
    </script>
</dom-module>
